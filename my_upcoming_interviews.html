<script>
const debugEl = id => document.getElementById(id);
const dbg = msg => {
  const el = debugEl('debug');
  el.textContent += msg + '\n';
  el.scrollTop = el.scrollHeight;
  console.log(msg);
};

function renderSlots(data) {
  const listEl = debugEl('slots-list');
  listEl.innerHTML = '';
  if (!Array.isArray(data) || data.length === 0) {
    listEl.innerHTML = '<li class="slot">No interviews scheduled yet.</li>';
    return;
  }
  data.sort((a,b)=> new Date(a.datetime.replace('+05:30','Z')) - new Date(b.datetime.replace('+05:30','Z')));
  data.forEach((slot) => {
    let dt = new Date(slot.datetime.replace('+05:30','Z'));
    const li = document.createElement('li');
    li.className = 'slot';
    if (isNaN(dt)) {
      li.innerHTML = '<span>‚ö†Ô∏è Invalid datetime: ' + (slot.datetime || JSON.stringify(slot)) + '</span>';
    } else {
      const text = dt.toLocaleString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit', hour12: true
      });
      li.innerHTML = '<span>üìÖ</span><span>' + text + '</span>';
    }
    listEl.appendChild(li);
  });
}

async function runDiagnostics() {
  debugEl('debug').textContent = '';
  dbg('Diagnostic started at: ' + (new Date()).toString());
  const basePath = window.location.pathname.replace(/[^\/]*$/, '');
  const candidates = [
    './slots.json',
    'slots.json',
    '/slots.json',
    basePath + 'slots.json',
    'https://raw.githubusercontent.com/naveenkumaritaimlds/naveenkumaritaimlds.github.io/main/slots.json'
  ].map(u => u + '?cache=' + Date.now());

  for (const url of candidates) {
    dbg('\nTrying: ' + url);
    try {
      const resp = await fetch(url, { cache: 'no-store' });
      dbg(' -> HTTP status: ' + resp.status + ' ' + resp.statusText);
      const text = await resp.text();
      const snippet = text.length > 1200 ? text.slice(0,1200) + '\n...[truncated]' : text;
      dbg(' -> body (snippet):\n' + snippet);
      try {
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) {
          dbg(' -> parsed JSON, but it is not an array (type: ' + typeof parsed + ').');
          continue;
        }
        dbg(' -> parsed JSON array, length: ' + parsed.length);
        dbg(' -> Rendering slots from this source.');
        renderSlots(parsed);
        return;
      } catch (pe) {
        dbg(' -> JSON parse error: ' + pe.message);
        continue;
      }
    } catch (fe) {
      dbg(' -> fetch error: ' + fe.message);
      continue;
    }
  }
  dbg('\nAll candidate fetch attempts failed or returned invalid JSON.');
  debugEl('debug').textContent += '\nYou can paste JSON into the inline editor and click "Load inline JSON" to continue.';
  renderSlots([]);
}

// Inline editor helpers
document.getElementById('runAgain').addEventListener('click', runDiagnostics);
document.getElementById('useInline').addEventListener('click', () => {
  const txt = document.getElementById('inlineEditor').value;
  try {
    const parsed = JSON.parse(txt);
    renderSlots(parsed);
    dbg('Loaded slots from inline editor (temporary).');
  } catch (e) {
    dbg('Inline JSON parse error: ' + e.message);
    alert('Invalid JSON in editor: ' + e.message);
  }
});
document.getElementById('loadInline').addEventListener('click', () => {
  document.getElementById('useInline').click();
});
document.getElementById('copySample').addEventListener('click', async () => {
  const sample = document.getElementById('inlineEditor').value;
  try { await navigator.clipboard.writeText(sample); dbg('Sample copied to clipboard.'); } catch(e){ dbg('Copy failed: ' + e.message); }
});

// initial run
runDiagnostics();
</script>
