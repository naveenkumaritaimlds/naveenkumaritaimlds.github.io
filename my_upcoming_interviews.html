<script>
const debugEl = id => document.getElementById(id);
const dbg = msg => {
  const el = debugEl('debug');
  el.textContent += msg + '\n';
  el.scrollTop = el.scrollHeight;
  console.log(msg);
};

function renderSlots(slots) {
  const listEl = debugEl('slots-list');
  listEl.innerHTML = '';
  if (!Array.isArray(slots) || slots.length === 0) {
    listEl.innerHTML = '<li class="slot">No interviews scheduled yet.</li>';
    return;
  }

  slots.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

  slots.forEach(slot => {
    const li = document.createElement('li');
    li.className = 'slot';
    try {
      let dt = new Date(slot.datetime);
      if (isNaN(dt)) throw new Error('Invalid date');
      // Force IST formatting
      const options = { 
        timeZone: 'Asia/Kolkata', weekday:'short', month:'short', day:'numeric', 
        year:'numeric', hour:'numeric', minute:'2-digit', hour12:true 
      };
      const text = dt.toLocaleString('en-US', options) + ' IST';
      li.innerHTML = '<span>üìÖ</span><span>' + text + '</span>';
    } catch(e) {
      li.innerHTML = '<span>‚ö†Ô∏è Invalid datetime: ' + (slot.datetime || JSON.stringify(slot)) + '</span>';
    }
    listEl.appendChild(li);
  });
}

async function runDiagnostics() {
  debugEl('debug').textContent = '';
  dbg('Diagnostic started at: ' + new Date());

  const basePath = window.location.pathname.replace(/[^\/]*$/, '');
  const candidates = [
    './slots.json',
    'slots.json',
    '/slots.json',
    basePath + 'slots.json',
    'https://raw.githubusercontent.com/naveenkumaritaimlds/naveenkumaritaimlds.github.io/main/slots.json'
  ].map(u => u + '?cache=' + Date.now());

  for (const url of candidates) {
    dbg('\nTrying: ' + url);
    try {
      const resp = await fetch(url, { cache:'no-store' });
      dbg(' -> HTTP status: ' + resp.status + ' ' + resp.statusText);
      const text = await resp.text();
      try {
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) {
          dbg(' -> Not an array, skipping.');
          continue;
        }
        dbg(' -> Parsed JSON array, length: ' + parsed.length);
        dbg(' -> Rendering slots from this source.');
        renderSlots(parsed);
        return;
      } catch(e) {
        dbg(' -> JSON parse error: ' + e.message);
        continue;
      }
    } catch(e) {
      dbg(' -> fetch error: ' + e.message);
      continue;
    }
  }

  dbg('\nAll fetch attempts failed or returned invalid JSON.');
  renderSlots([]);
}

document.getElementById('runAgain').addEventListener('click', runDiagnostics);
document.getElementById('useInline').addEventListener('click', () => {
  const txt = document.getElementById('inlineEditor').value;
  try {
    const parsed = JSON.parse(txt);
    renderSlots(parsed);
    dbg('Loaded slots from inline editor.');
  } catch(e) {
    dbg('Inline JSON parse error: ' + e.message);
    alert('Invalid JSON in editor: ' + e.message);
  }
});
document.getElementById('loadInline').addEventListener('click', () => document.getElementById('useInline').click());
document.getElementById('copySample').addEventListener('click', async () => {
  const sample = document.getElementById('inlineEditor').value;
  try { await navigator.clipboard.writeText(sample); dbg('Sample copied.'); } catch(e){ dbg('Copy failed: ' + e.message); }
});

// Initial run
runDiagnostics();
</script>
